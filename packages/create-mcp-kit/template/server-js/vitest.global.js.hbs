{{#if (and (includes plugins 'vitest') (or (includes transports 'streamable') (includes transports 'sse')))}}
import { spawn } from 'child_process'
import { waitForValue } from './tests/utils.js'

export default async function setup() {
  const webProcess = spawn('c8', ['--reporter=lcov', '--reporter=text', 'node', './src/index.js', 'web'], {
    stdio: 'pipe',
    env: {
      ...process.env,
      NODE_V8_COVERAGE: './coverage/tmp',
    },
  })
  let webStarted = false
  webProcess.stdout?.on('data', async data => {
    const output = data.toString()
    if (output.includes('MCP server started')) {
      webStarted = true
    }
  })
  await waitForValue(() => webStarted)
  return () => {
    webProcess.kill('SIGINT')
  }
}
{{/if}}
